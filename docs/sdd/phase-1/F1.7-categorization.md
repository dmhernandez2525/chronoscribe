# F1.7 - Category Classification

## Overview

| Attribute | Value |
|-----------|-------|
| Feature ID | F1.7 |
| Phase | 1 (MVP) |
| Priority | P0 |
| Status | Planned |
| Module | `chronoscribe.services.categorization` |

## Description

Automatic document type classification using AI analysis. Documents are classified into predefined categories (with support for custom categories) to enable organized filtering and browsing.

## Requirements

### Functional Requirements

1. **FR1.7.1** - Classify documents into predefined categories
2. **FR1.7.2** - Support multiple categories per document
3. **FR1.7.3** - Assign confidence scores to category assignments
4. **FR1.7.4** - Support custom user-defined categories
5. **FR1.7.5** - Allow manual category override

### Non-Functional Requirements

1. **NFR1.7.1** - Classification accuracy: > 90%
2. **NFR1.7.2** - Classification time: < 1 second (part of analysis)

## Technical Design

### Default Categories

```yaml
# config/categories.yaml
categories:
  # Document types by format
  - id: sketch
    name: Sketch
    description: Hand-drawn diagrams, designs, or illustrations
    keywords: [diagram, drawing, design, illustration, blueprint]

  - id: notes
    name: Notes
    description: Handwritten or typed notes and memos
    keywords: [memo, note, reminder, todo, list]

  - id: typed
    name: Typed Document
    description: Primarily typed/printed text documents
    keywords: [letter, report, document, form]

  - id: mixed
    name: Mixed Content
    description: Documents with both handwritten and typed content
    keywords: [annotated, marked up, filled form]

  # Document types by purpose
  - id: invention
    name: Invention/Idea
    description: Invention sketches, patent ideas, concepts
    keywords: [patent, invention, idea, concept, prototype]

  - id: journal
    name: Journal Entry
    description: Personal diary or journal entries
    keywords: [diary, journal, personal, reflection]

  - id: letter
    name: Correspondence
    description: Letters, cards, or written correspondence
    keywords: [letter, card, correspondence, greeting]

  - id: financial
    name: Financial
    description: Financial documents, receipts, invoices
    keywords: [receipt, invoice, budget, expense, tax]

  - id: medical
    name: Medical
    description: Medical records, prescriptions, health notes
    keywords: [medical, health, prescription, doctor, diagnosis]

  - id: legal
    name: Legal
    description: Legal documents, contracts, agreements
    keywords: [contract, agreement, legal, court, witness]

  - id: recipe
    name: Recipe
    description: Food recipes and cooking instructions
    keywords: [recipe, cooking, ingredients, bake, food]

  - id: meeting
    name: Meeting Notes
    description: Notes from meetings or discussions
    keywords: [meeting, agenda, minutes, discussion, action items]

  - id: project
    name: Project Document
    description: Project planning, tracking, or documentation
    keywords: [project, timeline, milestone, deliverable, task]

  - id: research
    name: Research
    description: Research notes, citations, findings
    keywords: [research, study, findings, citation, reference]

  - id: other
    name: Other
    description: Documents that don't fit other categories
    keywords: []
```

### Type Definitions

```python
from dataclasses import dataclass
from typing import Literal

@dataclass
class Category:
    """A document category."""
    id: str
    name: str
    description: str
    keywords: list[str]
    parent_id: str | None = None  # For hierarchical categories
    is_custom: bool = False

@dataclass
class CategoryAssignment:
    """Assignment of a category to a document."""
    category_id: str
    confidence: float
    is_primary: bool = False
    is_manual: bool = False  # True if manually assigned

@dataclass
class ClassificationResult:
    """Result of document classification."""
    assignments: list[CategoryAssignment]
    primary_category: str
    processing_time_ms: int
```

### Implementation

```python
class CategorizationService:
    """
    Classifies documents into categories using AI analysis.
    """

    def __init__(
        self,
        categories: list[Category],
        db: Database,
    ):
        self.categories = {c.id: c for c in categories}
        self.db = db

    def classify_from_analysis(
        self,
        analysis: AnalysisResult,
    ) -> ClassificationResult:
        """
        Classify document using analysis results.

        The analysis service already determines document_type,
        so this maps that to our category system.
        """
        start_time = time.time()
        assignments = []

        # Primary category from document type
        primary_id = self._map_document_type(analysis.document_type)
        assignments.append(CategoryAssignment(
            category_id=primary_id,
            confidence=analysis.document_type_confidence,
            is_primary=True,
        ))

        # Additional categories from tags and entities
        for tag in analysis.suggested_tags:
            category = self._find_category_for_tag(tag)
            if category and category.id != primary_id:
                assignments.append(CategoryAssignment(
                    category_id=category.id,
                    confidence=0.7,
                    is_primary=False,
                ))

        processing_time = int((time.time() - start_time) * 1000)

        return ClassificationResult(
            assignments=assignments,
            primary_category=primary_id,
            processing_time_ms=processing_time,
        )

    def _map_document_type(self, doc_type: DocumentType) -> str:
        """Map DocumentType enum to category ID."""
        mapping = {
            DocumentType.SKETCH: "sketch",
            DocumentType.NOTES: "notes",
            DocumentType.TYPED: "typed",
            DocumentType.MIXED: "mixed",
            DocumentType.LETTER: "letter",
            DocumentType.FORM: "typed",
            DocumentType.JOURNAL: "journal",
            DocumentType.INVENTION: "invention",
            DocumentType.RECIPE: "recipe",
            DocumentType.FINANCIAL: "financial",
            DocumentType.MEDICAL: "medical",
            DocumentType.LEGAL: "legal",
            DocumentType.OTHER: "other",
        }
        return mapping.get(doc_type, "other")

    def _find_category_for_tag(self, tag: str) -> Category | None:
        """Find a category that matches the tag."""
        tag_lower = tag.lower()
        for category in self.categories.values():
            if tag_lower in [k.lower() for k in category.keywords]:
                return category
            if tag_lower in category.name.lower():
                return category
        return None

    async def set_category(
        self,
        document_id: str,
        category_id: str,
        is_primary: bool = False,
    ) -> None:
        """Manually assign a category to a document."""
        if category_id not in self.categories:
            raise CategoryNotFoundError(category_id)

        assignment = CategoryAssignment(
            category_id=category_id,
            confidence=1.0,  # Manual = 100% confident
            is_primary=is_primary,
            is_manual=True,
        )

        await self.db.add_document_category(document_id, assignment)

    async def remove_category(
        self,
        document_id: str,
        category_id: str,
    ) -> None:
        """Remove a category from a document."""
        await self.db.remove_document_category(document_id, category_id)

    async def get_documents_by_category(
        self,
        category_id: str,
        limit: int = 50,
        offset: int = 0,
    ) -> list[str]:
        """Get document IDs in a category."""
        return await self.db.get_documents_by_category(
            category_id,
            limit=limit,
            offset=offset,
        )

    def load_categories(self, config_path: Path) -> list[Category]:
        """Load categories from YAML config."""
        import yaml

        with open(config_path) as f:
            config = yaml.safe_load(f)

        categories = []
        for cat_data in config.get("categories", []):
            categories.append(Category(
                id=cat_data["id"],
                name=cat_data["name"],
                description=cat_data.get("description", ""),
                keywords=cat_data.get("keywords", []),
                parent_id=cat_data.get("parent_id"),
                is_custom=cat_data.get("is_custom", False),
            ))

        return categories
```

### Database Schema

```sql
CREATE TABLE categories (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    parent_id TEXT REFERENCES categories(id),
    is_custom INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE document_categories (
    document_id TEXT REFERENCES documents(id),
    category_id TEXT REFERENCES categories(id),
    confidence REAL NOT NULL,
    is_primary INTEGER DEFAULT 0,
    is_manual INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (document_id, category_id)
);

CREATE INDEX idx_doc_categories_category ON document_categories(category_id);
```

### CLI Commands

```bash
# List all categories
chronoscribe categories

# View documents in category
chronoscribe categories show invention

# Add custom category
chronoscribe categories add --id "electronics" --name "Electronics Projects"

# Assign category to document
chronoscribe categorize <document-id> --category invention

# Remove category from document
chronoscribe uncategorize <document-id> --category notes
```

## Testing Strategy

### Unit Tests

```python
def test_map_document_type():
    service = CategorizationService(default_categories, mock_db)

    assert service._map_document_type(DocumentType.SKETCH) == "sketch"
    assert service._map_document_type(DocumentType.INVENTION) == "invention"
    assert service._map_document_type(DocumentType.OTHER) == "other"

def test_classify_assigns_primary():
    service = CategorizationService(default_categories, mock_db)
    analysis = AnalysisResult(
        document_type=DocumentType.INVENTION,
        document_type_confidence=0.9,
        ...
    )

    result = service.classify_from_analysis(analysis)

    assert result.primary_category == "invention"
    assert result.assignments[0].is_primary is True
    assert result.assignments[0].confidence == 0.9
```

## Acceptance Criteria

- [ ] Documents classified into predefined categories
- [ ] Multiple categories per document supported
- [ ] Confidence scores assigned
- [ ] Custom categories can be defined
- [ ] Manual override works
- [ ] Classification integrates with analysis service
- [ ] CLI commands work
- [ ] > 90% accuracy on test documents
